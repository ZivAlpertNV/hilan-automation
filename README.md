# Hilan Hours Filler - מילוי שעות אוטומטי בחילן

סקריפט אוטומציה למילוי שעות עבודה, פרויקט, וסימון נוכחות/חופשה/מחלה במערכת חילן (NVIDIA).
מתחבר לחילנט, וממלא את כל הנתונים הנדרשים לכל ימי העבודה (א'-ה') בחודש,
תוך דילוג אוטומטי על שבתות, שישי, וחגים ישראליים.

## תכונות עיקריות

- **מילוי שעות אוטומטי** - שעת כניסה ויציאה לכל ימי העבודה
- **מילוי פרויקט** - בחירה מתוך autocomplete עם retry אוטומטי
- **סימון Reporting Type** - `presence` (נוכחות במשרד) או `w.home` (עבודה מהבית)
- **חופשה ומחלה** - סימון ימי חופשה/מחלה עם מחיקת שעות ופרויקט אוטומטית
- **מילואים (Reserve Duty)** - סימון ימי מילואים עם העלאת צו מילואים אוטומטית
- **העלאת אישור מחלה** - צירוף קובץ אוטומטי כשיש 3+ ימי מחלה
- **זיהוי חגים** - דילוג אוטומטי על חגים ישראליים (ספריית `holidays`) עם הצגת שמות באנגלית
- **תיקון שגיאות** - מחיקת שורות שגויות (שישי/שבת) ותיקון סמלים שגויים
- **ממשק אינטראקטיבי** - הזנה מונחית ב-8 שלבים עם לוח שנה ויזואלי צבעוני
- **מסך עריכה** - טבלה דו-עמודית של 14 פרמטרים עם לוח שנה מתעדכן בזמן אמת
- **Dry Run** - הצגת מה ישתנה ללא ביצוע בפועל

## דרישות מקדימות

- **Python 3.10+** — [הורדה מכאן](https://www.python.org/downloads/)
  - ב-Windows: סמנו "Add Python to PATH" בזמן ההתקנה
  - ב-Mac: אפשר גם דרך Homebrew: `brew install python`

## התקנה

### 1. שכפול הפרויקט

```bash
git clone https://github.com/ZivAlpertNV/hilan-automation.git
cd hilan-automation
```

### 2. יצירת סביבה וירטואלית (מומלץ)

**Windows (PowerShell):**
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
```

**Mac / Linux:**
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. התקנת תלויות Python

```bash
pip install -r requirements.txt
```

### 4. התקנת דפדפן Chromium עבור Playwright

**Windows (PowerShell):**
```powershell
$env:PLAYWRIGHT_BROWSERS_PATH="0"; python -m playwright install chromium
```

**Mac / Linux:**
```bash
python -m playwright install chromium
```

## שימוש

### אופציה מומלצת: Interactive Runner

הדרך הכי קלה ונוחה להשתמש בכלי. הסקריפט האינטראקטיבי מדריך אותך שלב-שלב דרך כל הפרמטרים, מציג לוח שנה ויזואלי צבעוני, ומריץ את מילוי השעות בסוף.

```bash
python hilan_interactive.py
```

> **Mac:** אם `python` לא עובד, נסו `python3 hilan_interactive.py`

#### התהליך האינטראקטיבי (7 שלבים):

1. **Step 1/7 — Login Credentials** - מספר עובד וסיסמה (הסיסמה מוזנת בצורה מאובטחת עם אישור כפול)
2. **Step 2/7 — Select Month** - בחירת חודש ושנה (ברירת מחדל: חודש ושנה נוכחיים)
3. **Step 3/7 — Project** - קוד/שם פרויקט (למשל `12086 - AGUR IC`)
4. **Step 4/8 — Vacation** - סימון ימי חופשה, תומך בטווחים (`8-12`) וימים בודדים (`1,3,15`)
5. **Step 5/8 — Sick Days** - סימון ימי מחלה, כולל צירוף אישור מחלה אוטומטי ב-3+ ימים
6. **Step 6/8 — Reserve Duty (מילואים)** - סימון ימי מילואים עם צירוף צו מילואים
7. **Step 7/8 — Office Days** - ימים קבועים בשבוע שבהם אתה במשרד (ברירת מחדל: שני ורביעי — `2,4`)
8. **Step 8/8 — Review** - לוח שנה צבעוני מלא → מעבר למסך עריכה

#### מסך העריכה

לאחר השלב ה-7, נפתח מסך עריכה אינטראקטיבי עם לוח שנה קומפקטי וטבלת פרמטרים דו-עמודית:

| # | פרמטר | # | פרמטר |
|---|---|---|---|
| 1 | Employee# | 8 | Office wk (ימי משרד שבועיים) |
| 2 | Password | 9 | Office dt (תאריכי משרד ספציפיים) |
| 3 | Month | 10 | Vacation |
| 4 | Year | 11 | Sick days |
| 5 | Project | 12 | RD days (מילואים) |
| 6 | Entry (שעת כניסה) | 13 | Headless |
| 7 | Exit (שעת יציאה) | 14 | Dry-run |
|   |                    | d  | Done — סיום עריכה |

> בכל שינוי, לוח השנה מתעדכן מיד ומשקף את הפרמטרים החדשים.

#### לוח שנה ויזואלי צבעוני

הלוח מוצג בפורמט שבוע ישראלי (ראשון-שבת) עם סימון צבעוני:

- 🟢 ירוק — ימי עבודה מהבית (w.home)
- 🔵 תכלת — ימי נוכחות במשרד (presence)
- 🟣 סגול — ימי חופשה (vacation)
- 🟡 צהוב — ימי מחלה (sick)
- 🔵 כחול — ימי מילואים (reserve duty)
- 🔴 אדום — חגים ישראליים (מוצגים עם שם החג באנגלית)
- ⚪ אפור — סופ"ש (שישי/שבת)

#### תכונות נוספות ב-Interactive Runner:

- **אישור סיסמה כפול** - הסיסמה מוזנת פעמיים לאימות ומוצגת כ-`****`
- **בדיקת חפיפות** - זיהוי אוטומטי של חפיפות בין חופשה/מחלה/מילואים/נוכחות עם אזהרה מיידית
- **ולידציה בזמן אמת** - כל שדה נבדק מיד עם הזנה
- **ניקוי מסך** - המסך מתנקה בין שלבים לנוחות קריאה
- **סיכום לפני הרצה** - תצוגת כל הפרמטרים + הפקודה שתורץ, עם אפשרות ל-Run / Edit / Quit

> **טיפ:** מומלץ מאוד להשתמש ב-Interactive Runner במקום להעביר פלאגים ידנית. זה מונע טעויות ומקל על התהליך.

---

### שימוש ישיר (CLI) - אופציה מתקדמת

אם מעדיפים להעביר את כל הפרמטרים ישירות בשורת הפקודה:

#### דוגמה מלאה - שעות + פרויקט + נוכחות + חופשה

```powershell
python hilan_filler.py `
  -u 123456 -p mypassword `
  --project "AGUR" `
  --present-days 2,4 `
  --present-dates 12,19 `
  --vacation 1,3-5
```

בדוגמה למעלה:
- כל ימי שני ורביעי יסומנו כ-**presence** (נוכחות קבועה במשרד)
- ה-12 וה-19 בחודש גם יסומנו כ-**presence** (נוכחות חד-פעמית)
- ימי ראשון, שלישי, רביעי, חמישי (1,3,4,5) יסומנו כ-**vacation** (חופשה)
- שאר הימים ימולאו עם שעות (09:00-18:00) ופרויקט, כ-**w.home**

#### מילוי בסיסי - שעות ופרויקט בלבד

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR"
```

#### סימון ימי נוכחות במשרד (presence)

יש שתי דרכים לסמן ימי נוכחות - אפשר להשתמש בשתיהן ביחד:

##### 1. ימים קבועים בשבוע (`--present-days`)

ימים שבהם אתה במשרד **כל שבוע** יסומנו כ-"presence", שאר הימים כ-"w.home":

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --present-days 2,4
```

פורמט הימים: **1**=ראשון, **2**=שני, **3**=שלישי, **4**=רביעי, **5**=חמישי

##### 2. תאריכים ספציפיים בחודש (`--present-dates`)

ימים ספציפיים בחודש שבהם היית במשרד (לא חוזרים כל שבוע):

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --present-dates 5,12,19
```

תומך בפורמטים:
- ימים בודדים: `5,12,19`
- טווח: `10-14` (ימים 10 עד 14)
- שילוב: `5,10-14,19`

##### שילוב שני הסוגים

אפשר לשלב ימים קבועים בשבוע עם תאריכים ספציפיים:

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --present-days 2 --present-dates 12,19
```

בדוגמה למעלה:
- כל יום **שני** יסומן כ-presence (חוזר כל שבוע)
- ה-**12** וה-**19** בחודש גם יסומנו כ-presence (חד-פעמי)

#### סימון ימי חופשה

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --vacation 8-12
```

תומך בפורמטים:
- טווח: `8-12` (ימים 8 עד 12)
- ימים בודדים: `8,10,12`
- שילוב: `1-3,15,20-22`

ימי חופשה יסומנו כ-"vacation" ב-Reporting Type. שעות ופרויקט יימחקו אוטומטית מימי חופשה.

#### סימון ימי מחלה

**1-2 ימים (sick day declaration - ללא אישור מחלה):**

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --sick-days 15,16
```

**3+ ימים (sick - עם אישור מחלה):**

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --sick-days 15-19 --sick-file "C:\path\to\sick_certificate.pdf"
```

הלוגיקה:
- **1-2 ימי מחלה** → "sick day declaration" (value=5) - לא צריך לצרף אישור
- **3+ ימי מחלה** → "sick" (value=6) - חובה לצרף אישור מחלה (`--sick-file`)
- שעות ופרויקט יימחקו אוטומטית מימי מחלה
- אישור המחלה יועלה אוטומטית דרך דיאלוג ההעלאה של חילן

#### סימון ימי מילואים (Reserve Duty)

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --rd-days 5-7 --rd-file "C:\path\to\reserve_duty_order.pdf"
```

הלוגיקה:
- סימון ימי מילואים כ-"מילואים – RD" ב-Reporting Type (הערך מתגלה אוטומטית מתוך ה-dropdown)
- חובה לצרף צו מילואים (`--rd-file`) — הקובץ מועלה אוטומטית לכל יום מילואים
- שעות ופרויקט יימחקו אוטומטית מימי מילואים
- תומך בפורמטים: ימים בודדים (`5,6,7`), טווחים (`5-7`), או שילוב (`5-7,15`)

#### שעות מותאמות אישית

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --start-time 08:30 --end-time 17:30
```

#### בחירת חודש ספציפי

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --month 1 --year 2026
```

#### הרצת dry-run (לראות אילו ימים ימולאו בלי לבצע שינויים)

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --dry-run
```

#### הרצה ללא חלון דפדפן (headless)

```powershell
python hilan_filler.py -u 123456 -p mypassword --project "AGUR" --headless
```

## כל הפלאגים

| פלאג | ברירת מחדל | תיאור |
|---|---|---|
| `-u`, `--user` | **חובה** | מספר עובד |
| `-p`, `--password` | **חובה** | סיסמה |
| `--project` | **חובה** | קוד/שם פרויקט לחיפוש ב-autocomplete (למשל "AGUR" או "12086 - AGUR IC") |
| `--present-days` | ללא | ימים קבועים בשבוע שאתה במשרד **כל שבוע**. פורמט: 1=א, 2=ב, 3=ג, 4=ד, 5=ה |
| `--present-dates` | ללא | תאריכים ספציפיים בחודש שהיית במשרד. תומך בטווחים: "5,12,19", "10-14" |
| `--vacation` | ללא | ימים בחודש לסמן כחופשה. מוחק שעות ופרויקט. תומך בטווחים: "1-6", "8,15,20-22" |
| `--sick-days` | ללא | ימים בחודש לסמן כמחלה. 1-2 ימים: "sick day declaration". 3+: "sick" (דורש `--sick-file`) |
| `--sick-file` | ללא | נתיב לאישור מחלה (חובה כש-`--sick-days` מעל 2 ימים) |
| `--rd-days` | ללא | ימים בחודש לסמן כמילואים. דורש `--rd-file`. תומך בטווחים: "5-7", "10,11,12" |
| `--rd-file` | ללא | נתיב לצו מילואים (חובה כש-`--rd-days` מוגדר) |
| `--start-time` | `09:00` | שעת כניסה |
| `--end-time` | `18:00` | שעת יציאה |
| `--month` | חודש נוכחי | חודש (1-12) |
| `--year` | שנה נוכחית | שנה (2020-2030) |
| `--headless` | `false` | הרצה ללא חלון דפדפן |
| `--dry-run` | `false` | הדפסת ימים בלבד, ללא ביצוע |
| `--verbose` | `false` | לוגים מפורטים לדיבוג |
| `--slow-mo` | `500` | האטת פעולות הדפדפן (מילישניות) |

## ולידציה אוטומטית

הסקריפט מבצע בדיקות ולידציה לפני הרצה:
- **חפיפות** - בדיקה שאין חפיפה בין ימי חופשה, מחלה, מילואים, ונוכחות (גם present-dates וגם present-days)
- **פורמט שעות** - וידוא פורמט HH:MM תקין (00:00 - 23:59)
- **חודש/שנה** - וידוא טווח תקין (חודש 1-12, שנה 2020-2030)
- **אישור מחלה** - חובת צירוף קובץ ב-3+ ימי מחלה, עם בדיקה שהקובץ קיים
- **צו מילואים** - חובת צירוף קובץ כשימי מילואים מוגדרים, עם בדיקה שהקובץ קיים
- **ימים בשבוע** - וידוא שימים קבועים הם 1-5 (א'-ה')

## איך זה עובד

הסקריפט עובד בשני מעברים (Two-Pass) כדי להתמודד עם postbacks של ASP.NET:

### Pass 1 - פעולות Postback (חופשה, מחלה, מילואים, תיקון סמלים)

1. **התחברות** - נכנס לחילנט עם מספר עובד וסיסמה
2. **ניווט** - עובר לדף "Report & Update" (דיווח נוכחות)
3. **בחירת חודש** - מוודא שהחודש הנכון מוצג בלוח השנה
4. **בחירת ימים** - לוחץ על `>>` לבחירת כל הימים בחודש
5. **Days Selected** - לוחץ על "Days selected" להצגת כל הימים בטבלה
6. **מחיקת שורות שגויות** - מחיקת שורות שישי/שבת שמכילות נתונים שגויים
7. **סימון חופשה** - שינוי Reporting Type ל-"vacation" ומחיקת שעות/פרויקט
8. **סימון מחלה** - שינוי ל-"sick day declaration" או "sick" + העלאת אישור
9. **סימון מילואים** - שינוי ל-"מילואים – RD" + מחיקת שעות/פרויקט + העלאת צו מילואים
10. **תיקון סמלים** - מחיקת שורות absence שגויות ותיקון presence/w.home

> **חשוב:** כל פעולת postback מרעננת את הגריד ומשנה את מספרי השורות. לכן הסקריפט קורא מחדש את הגריד אחרי כל postback וחוזר על הסריקה עד שאין עוד שינויים נדרשים (עד 50 סריקות מחדש).

### Pass 2 - מילוי שעות ופרויקטים (ללא postbacks)

11. **מילוי שעות** - ממלא שעת כניסה ויציאה לכל יום עבודה (א'-ה') דרך JavaScript (מדלג על חופשה/מחלה/מילואים)
12. **Reporting Type** - מוודא "presence" בימי נוכחות, "w.home" בשאר
13. **מילוי פרויקט** - ממלא את קוד הפרויקט דרך autocomplete (עם retry אוטומטי עד 3 ניסיונות + JS fallback)
14. **Retry פרויקט** - ניסיון חוזר לשורות שנכשלו (בדרך כלל השורה הראשונה שבה ה-autocomplete עוד לא מאותחל)
15. **שמירה** - לוחץ Save לשמירת כל הנתונים

> **חשוב:** הסקריפט בודק כל שדה ומעדכן רק מה שצריך. אם הערכים כבר נכונים - הוא מדלג. אם ערך שגוי קיים - הוא דורס אותו.

## הערות חשובות

### הרצה ראשונה
מומלץ להריץ **בלי** `--headless` (ברירת המחדל) כדי לראות את הדפדפן פועל ולוודא שהכל עובד.

### Dry Run
מומלץ להריץ עם `--dry-run` קודם כדי לראות בדיוק אילו ימים ימולאו.

### חגים ישראליים
הסקריפט מזהה אוטומטית חגים ישראליים ומדלג עליהם (ספריית `holidays`).
שמות החגים מוצגים באנגלית בלוח השנה (language: `en_US`).

### ימים עתידיים
הסקריפט כולל את כל ימי החודש (כולל עתידיים) ברשימת הימים. שעות **לא** ימולאו לימים עתידיים, אבל Reporting Type (סמל) **כן** יתוקן גם בימים עתידיים.

### חלון הדפדפן
בסיום ההרצה (ללא headless), הדפדפן נשאר פתוח 10 שניות כדי לראות את התוצאה. אפשר ללחוץ `Ctrl+C` כדי להשאיר אותו פתוח.

### צילומי מסך
הסקריפט שומר צילומי מסך אוטומטית בכל שלב לתיקייה `screenshots/` לצורך דיבוג:
- `01_login_page` - דף ההתחברות
- `02_credentials_filled` - לאחר מילוי פרטים
- `03_after_login` - לאחר התחברות
- `04_attendance_page` - דף הנוכחות
- `05_month_selected` - לאחר בחירת חודש
- `06_workdays_selected` - לאחר בחירת ימים
- `07_grid_before_fill` - הגריד לפני מילוי
- `08_before_save` - לפני שמירה
- `09_after_save` - לאחר שמירה
- `99_final_state` - מצב סופי

### Modals ו-Dialogs
הסקריפט מזהה ומסגר אוטומטית modals של ASP.NET (`MPEBehavior`, `mDialogEx`, ו-grid dialogs) שעלולים לחסום אינטראקציות.

### אבטחה
הסיסמה מועברת כפרמטר CLI. ב-PowerShell ניתן להשתמש ב:

```powershell
$pw = Read-Host -AsSecureString "Password"
$plainPw = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($pw))
python hilan_filler.py -u 123456 -p $plainPw --project "AGUR"
```

ב-Interactive Runner הסיסמה מוזנת בצורה מאובטחת (לא מוצגת על המסך) עם אישור הקלדה כפול.

## מבנה הפרויקט

```
hilan-automation/
├── hilan_interactive.py  # ממשק אינטראקטיבי מונחה 7 שלבים + מסך עריכה (מומלץ!)
├── hilan_filler.py       # מנוע מילוי השעות (Playwright automation, ~1900 שורות)
├── requirements.txt      # תלויות: playwright, holidays
├── .env.example          # דוגמה לקובץ env (אופציונלי)
├── README.md             # מסמך זה
└── screenshots/          # צילומי מסך אוטומטיים (נוצר בזמן ריצה)
```

## תלויות

| חבילה | תיאור |
|---|---|
| `playwright` | אוטומציית דפדפן (Chromium) |
| `holidays` | ספריית חגים ישראליים |

> **הערה:** הסקריפט מגדיר `PLAYWRIGHT_BROWSERS_PATH=0` אוטומטית כדי שהדפדפנים יותקנו לצד החבילה.
